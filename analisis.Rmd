---
title: "Caso de estudio"
description: |
  Tema de análisis
site: distill::distill_website
---

# LIBRERIAS

```{r, include=FALSE}
options(scipen = 999)

knitr::opts_chunk$set(echo = TRUE)
library(bootstrap)
library(bslib)
library(data.table)
library(dplyr)
library(DT)
library(geofacet)
library(ggmap)
library(ggplot2)
library(googlesheets4)
library(installr)
library(janitor)
library(knitr)
library(leaflet)
library(leaflet.extras)
library(lubridate)
library(lwgeom)
library(maptools)
library(openxlsx)
library(osmdata)
library(osrm)
library(plotly)
library(purrr)
library(RColorBrewer)
library(readxl)
library(readr)
library(rgdal)
library(rgeos)
library(rmarkdown)
library(rsconnect)
library(scales)
library(sf)
#library(shiny)
#library(shinydashboard)
#library(shinyjs)
library(sodium)
library(sp)
library(stringr)
library(tidygeocoder)
library(tidyr)
library(tidyverse)
library(viridis)
library(viridisLite)
library(vroom)
library(writexl)
```

<h1>
BUENOS AIRES EN 15 MINUTOS </br>
  <small class="text-muted"> || Hipótesis </small>
</h1>


<h3>
  CONTEXTO ACTUAL </br>
  <small class="text-muted"> |  Nacional </small>
</h3>

**HIPÓTESIS**



#GOOGLE SHEET
```{r}
gs4_deauth() # Eliminar auth interactivo (link publico)
variables = read_sheet("https://docs.google.com/spreadsheets/d/15K_hQPI8NeN-vGZoND9f9yWvzg82VgPx-S1nffsJ3LQ/edit#gid=0")

```


#BARRIOS

```{r}
barrios <- st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-educacion/barrios/barrios.geojson") %>% 
  mutate(AREAKM2 = round((AREA/1000000),2)) %>% 
  st_transform(4326)


centroides = st_centroid(barrios) %>% 
             st_transform(4326)

puntos_aleatorios <- rowwise(barrios) %>%
  mutate(punto_aleatorio = st_sample(geometry, 1, type = "random")) %>% 
  st_drop_geometry(geometry) %>% 
  st_as_sf()
```
#ISOCRONAS


```{r}
#ESTA SECCIÓN VOY A EJECUTARLA UNA SOLA VEZ Y GUARDO EL OBJETO PORQUE TARDA MUCHO:
# itero en cada punto para hacer las isocronas
#lista_isocronas <- lapply(puntos_aleatorios$punto_aleatorio, function(point) {
#  osrmIsochrone(loc = st_coordinates(point),
#                breaks = seq(from = 0, to = 15, by = 15),
#                res = 40,
#                osrm.profile = "foot")
#})

# Combino las isocronas
#isocronas_bind <- do.call(rbind, lista_isocronas)

#st_write(isocronas_bind, "data/isocronas_aleatorios.geojson")

#Ahora simplemente llamo la base que armé y le uno los nombres por orden de las observaciones
isocronas_barrios = st_read("data/isocronas_aleatorios.geojson") %>% 
                    st_transform(4326) %>% 
                    cbind(st_drop_geometry(centroides)) %>% 
                    st_make_valid()

```

# MAPA

pal_tenencia <- colorFactor(
  palette = brewer.pal(10, "OrRd"), # Cambia la paleta y el número de colores según tu preferencia
  domain = tenencia_prov$inquilinos
)

```{r, echo = FALSE, warning = FALSE, out.width = "100%"}


leaflet(st_zm(barrios) %>% st_transform(4326)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Barrios CABA", "Centroides","Puntos Aleatorios","Puntos Aleatorios2","Isocrona"))%>% 
  
  addPolygons(data= barrios,
              color = "black",
              weight = 0.4,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0.5,
              popup = ~paste("<strong> BARRIO: </strong>", BARRIO,"<br> <strong> ÁREA: </strong>", AREAKM2, "km2"),
              group = "Barrios CABA") %>% 
  
    addCircleMarkers(data=puntos_aleatorios,
              fillColor = "green",
              weight = 0.5,
              color = "green",
              fillOpacity = 0.5,
              radius = 2,
              popup = ~paste("<strong> BARRIO: </strong>", BARRIO),
              group = "Puntos Aleatorios")  %>% 

  addPolygons(data= isocronas_barrios,
              color = "darkgreen",
              weight = 0.4,
              opacity = 0.7,
              fillColor = "darkgreen",
              fillOpacity = 0.5,
              popup = ~paste("<strong> BARRIO: </strong>", BARRIO),
              group = "Isocrona")

```

```{r}
isocronas_inter = isocronas_barrios %>% 
                          select(BARRIO)

conteo_interno = function(db, nombre_variable){
  db %>% 
  st_transform(4326) %>% 
  st_intersection(isocronas_inter) %>%
  group_by(BARRIO) %>%
  summarise(!!nombre_variable := n())
}
```

# SEGURIDAD
```{r}
#TOMO CADA BASE DE DATOS, LA INTERSECTO Y HAGO EL CONTEO:

se_comisarias = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-justicia-y-seguridad/comisarias-policia-ciudad/comisarias-policia-de-la-ciudad.geojson") %>% 
  select(nombre, nom_2,tipo) %>% 
  conteo_interno("n_se_comisarias")
  
  
se_bomberos = read.csv("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-justicia-y-seguridad/cuarteles-destacamentos-bomberos/cuarteles-y-destacamentos-de-bomberos-de-policia-federal-argentina.csv",
                    stringsAsFactors = T) %>% 
  select(long,lat,dcia,gestion) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_se_bomberos")

```


# SALUD
```{r}
s_ufebriles = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/ufus/ubicacion-ufus.geojson")  %>% 
  conteo_interno("n_s_ufebriles")

s_cimujer = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/centros-integrales-mujer/centros-integrales-de-la-mujer.xlsx") %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_s_cimujer")

s_hospitales = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/hospitales/hospitales.geojson")  %>% 
  conteo_interno("n_s_hospitales")

s_cdinfantil = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/centros-desarrollo-infantil/centros-de-desarrollo-infantil.geojson")  %>% 
  conteo_interno("n_s_cdinfantil")

s_farmacias = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/farmacias/farmacias.xlsx") %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_s_farmacias")

s_privados = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/centros-salud-privados/centros-de-salud-privados.xlsx") %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_s_privados")

s_vinfantil = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/vacunatorios-infantiles/vacunatorios_infantiles_WGS84.geojson")  %>% 
  conteo_interno("n_s_vinfantil")

s_cesac = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/centros-salud-accion-comunitaria-cesac/centros_de_salud_nivel_1_BADATA_WGS84.geojson")  %>% 
  conteo_interno("n_s_cesac")

s_vmayores = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/vacunatorios-adultos-mayores/vacunatorios-adultos-mayores.geojson")  %>% 
  conteo_interno("n_s_vmayores")

s_barriales = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-salud/centros-medicos-barriales/centros-medicos-barriales.geojson")  %>% 
  conteo_interno("n_s_barriales")

s_geriatricos = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-justicia-y-seguridad/geriatricos/geriatricos.geojson")  %>% 
  conteo_interno("n_s_geriatricos")

s_esaludables = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/vicejefatura-de-gobierno/estaciones-saludables/estaciones-saludables.geojson")  %>% 
  conteo_interno("n_s_esaludables")

s_veterinarias = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/agencia-de-proteccion-ambiental/centros-atencion-veterinaria/centros-de-atencion-veterinaria.xlsx") %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_s_veterinarias")

```

# CULTURA Y RECREACION
```{r}
r_culturales = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-cultura/espacios-culturales/espacios-culturales.geojson")  %>% conteo_interno("n_r_culturales")
  

r_polideportivos = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/vicejefatura-de-gobierno/polideportivos/polideportivos.geojson")  %>% 
  conteo_interno("n_r_polideportivos")

r_clubes = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/vicejefatura-de-gobierno/clubes/clubes.geojson") %>% 
  conteo_interno("n_r_clubes")

r_jugotecas = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/juegotecas-barriales/juegotecas-barriales.geojson") %>% 
  conteo_interno("n_r_jugotecas")

r_skate = read.csv("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/vicejefatura-de-gobierno/pistas-skate/pistas-de-skate.csv",
                    stringsAsFactors = T) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_r_skate")

r_monumentos = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-espacio-publico-e-higiene-urbana/monumentos/monumentos.xlsx") %>% 
  filter(!is.na(LATITUD)) %>% 
  st_as_sf(coords = c("LONGITUD", "LATITUD"), crs = 4326) %>% 
  conteo_interno("n_r_monumentos") %>% 
  filter(!is.na(BARRIO))

r_estadios = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/vicejefatura-de-gobierno/estadios/estadios.xlsx") %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_r_estadios") 

r_peatonal = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/juegotecas-barriales/juegotecas-barriales.geojson") %>% 
  conteo_interno("n_r_peatonal")

r_gastronomicos = st_read("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ente-de-turismo/oferta-establecimientos-gastronomicos/oferta-gastronomica.geojson") %>% 
  conteo_interno("n_r_gastronomicos")

r_jubilados = read.xlsx("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/ministerio-de-desarrollo-humano-y-habitat/centros-jubilados/centros-de-jubilados-reempadronados.xlsx") %>% 
  filter(!is.na(lat)) %>% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %>% 
  conteo_interno("n_r_jubilados") 
```

#UNIFICADO
```{r}
bases_de_datos <- ls() %>%
  grep("^r_|^se_|^s_", ., value = TRUE) %>%
  lapply(get)

# Realizo los left_join iterativos
isocronas_datos <- bases_de_datos %>% 
  reduce(function(df1, df2) {
    left_join(df1, df2 %>% st_drop_geometry(), by = "BARRIO") %>%
      replace(is.na(.), 0)
  }, .init = isocronas_barrios)
```

#EDUCACION

#PONDERACIONES
Si bien la rigurosidad metodologia de estas ponderaciones es practicamente inexistente debido a que no tiene un respaldo teorico, sino que se basa en mi subjetividad, la idea es plantear al menos algun tipo de diferencia en el peso de cada subitem de los indices para reconocer que no deberían ser iguales; y dejar asentada una forma de calcularlo.



#MAPA con puntos

```{r, echo = FALSE, warning = FALSE, out.width = "100%"}


leaflet(st_zm(barrios) %>% st_transform(4326)) %>%
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron, group = "OSM",
                   options = providerTileOptions(minzoom = 1, maxzoom = 15)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
  addLayersControl(
    baseGroups = c("OSM","Satelite"), 
    overlayGroups = c("Barrios CABA", "Comisarias", "Isocronaa"))%>% 
  
  addPolygons(data= barrios,
              color = "black",
              weight = 0.4,
              opacity = 0.7,
              fillColor = "white",
              fillOpacity = 0.5,
              popup = ~paste("<strong> BARRIO: </strong>", BARRIO,"<br> <strong> ÁREA: </strong>", AREAKM2, "km2"),
              group = "Barrios CABA") %>% 
  
  addCircleMarkers(data=comisarias_dentro,
              fillColor = "purple",
              weight = 0.5,
              color = "purple",
              fillOpacity = 0.5,
              radius = 2,
              #popup = ~paste("<strong> BARRIO: </strong>", BARRIO),
              group = "Comisarias")%>% 

  addPolygons(data= isocronas_barrios,
              color = "darkgreen",
              weight = 0.4,
              opacity = 0.7,
              fillColor = "darkgreen",
              fillOpacity = 0.5,
              popup = ~paste("<strong> BARRIO: </strong>", BARRIO),
              group = "Isocronas")

```

